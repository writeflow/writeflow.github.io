<!doctype html>
<html>
<head>
<meta name="viewport" content="width=device-width, initial-scale=1.0, maximum-scale=1.0, minimum-scale=1.0, user-scalable=no">
</head>

<style>
html, body, textarea {
  background-color: #000;
  color: #eee;
}
html, body {
  font-family: sans-serif;
}
html, body, .maxWidth, textarea {
  height: 100%;
  width: 100%;
  padding: 0;
  margin: 0;
}
@media (min-width: 80rem) {
  html, body {
    background-color: #111;
  }
  .maxWidth {
    background-color: #000;
    width: 80rem;
    margin: 0 auto;
  }
  html textarea {
    width: 78rem;
    padding: 1rem;
  }
}
.maxWidth {
  display: flex;
  flex-direction: column;
}
textarea {
  display: block;
  border: none;
  outline: none;
  padding: 0;
  margin: 0;
  line-height: 1.23rem;
  overflow: hidden;
  resize: none;
  flex: 1;
}
.controls {
  flex: 0 3rem;
  display: flex;
  border-bottom: 3px solid #999;
}
.controls > div {
  flex: 1;
  border-right: 1px solid #999;
  background-color: #222;
  line-height: 3rem;
  text-align: center;
}
.controls > div:last-child {
  border-right: 0px none;
}
.button {
  cursor: pointer;
}
.fullscreen .controls {
  display: none;
}
.noHighlight::selection {
  background: rgba(0,0,0,0);
}
</style>

<body>
<div class="maxWidth">
  <div class="controls">
    <div class="stats"></div>
    <div class="copy button" onclick="copy()">Copy</div>
    <div class="reset button" onclick="reset()">Clear</div>
  </div>
  <textarea ontouchstart="immersive(event)" onmousedown="immersive(event)" placeholder="WriteFlow: distraction free writing
- click here to start writing
- all changes will be saved
- use copy to get your writing out
- use clear to clear the slate
- dont edit, just write!"></textarea>
</div>

<script>
const textarea = document.querySelector('textarea');
const stats = document.querySelector('.stats');

var startDate = Date.now();
var totalTime = parseInt(window.localStorage.getItem('totalTime') || '0', 10);
textarea.value = window.localStorage.getItem('text') || '';
var firstClick = true;

const prevent = event => event.preventDefault();
function immersive(event) {
  event.preventDefault();
  textarea.blur();
  setTimeout(() => {
    textarea.focus();
    selectEnd();
  }, 10);
  document.body.requestFullscreen();
  wakelock();
};

textarea.addEventListener('selectstart', prevent);
textarea.addEventListener('keydown', event => {
  if (event.key.startsWith('Arrow')) {
    event.preventDefault();
  } else if (event.key == 'Enter') {
    const start = textarea.selectionStart;
    const prevLineIndex = textarea.value.lastIndexOf('\n', start - 1);
    const prevLine = textarea.value.substring(prevLineIndex + 1, start)
    const header = prevLine.split(/[^ *-]/, 1)[0];
    event.preventDefault();
    if (header.length < prevLine.length || header.length == 0) {
      document.execCommand('insertText', true, '\n' + header);
    } else {
      editorIndent(-2);
    }
  } else if (event.key == 'Tab') {
    editorIndent(event.shiftKey ? -2 : 2);
    event.preventDefault();
  }
});

document.addEventListener('fullscreenchange', e => {
  const fullScreen = document.fullscreenElement !== null;
  document.body.classList.toggle('fullscreen', fullScreen);
});

function save() {
  window.localStorage.setItem('text', textarea.value);
  window.localStorage.setItem('totalTime', totalTime + Date.now() - startDate);
};
window.addEventListener('beforeunload', save);
setInterval(save, 60 * 1000);

function updateStats() {
  stats.innerText = durationToString(Date.now() - startDate) + ' / ' + durationToString(totalTime + Date.now() - startDate);
}
updateStats();
setInterval(updateStats, 60 * 1000);

function copy() {
  textarea.classList.add('noHighlight');
  textarea.select();
  document.execCommand('copy');
  selectEnd();
  textarea.classList.remove('noHighlight');
  textarea.blur();
}

function selectEnd() {
  const end = textarea.value.length
  textarea.setSelectionRange(end, end);
}

function reset() {
  if (confirm('delete all text?')) {
    textarea.value = '';
    startDate = Date.now();
    totalTime = 0;
    save();
    updateStats();
  }
}

var wakelockVideo = undefined;
function wakelock() {
  if (!wakelockVideo) {
    wakelockVideo = document.createElement('video');
    wakelockVideo.setAttribute('playsinline', '');
    wakelockVideo.setAttribute('src', 'data:video/mp4;base64, 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');
    wakelockVideo.playbackRate = 0;
  }
  if (wakelockVideo.paused) {
    wakelockVideo.play();
  }
}

function editorIndent(amount) {
  const search = amount > 0 ? /(^|\n)/g : /(^|\n)[ *-][ *-]/g;
  const replace = '$1' + (amount > 0 ? new Array(amount+1).join(' ') : '');
  editorReplace(search, replace);
}

function editorReplace(search, replacement) {
  const start = textarea.selectionStart, end = textarea.selectionEnd;
  const prevLine = textarea.value.lastIndexOf('\n', start - 1) + 1;
  const original = textarea.value.substring(prevLine, end);
  const updated = original.replace(search, replacement);
  if (original != updated) {
    const offset = textarea.value.substring(end, 1) == '\n' ? -1 : 0;
    textarea.setSelectionRange(prevLine, end - offset);
    textarea.classList.add('noHighlight');
    setTimeout(() => {
      if (updated.length == 0) {
        document.execCommand('delete', true);  // chrome bug when you insert '' into end of textarea
      } else {
        document.execCommand('insertText', true, updated);
      }
      textarea.classList.remove('noHighlight');
      if (updated.indexOf('\n') > -1) {
        textarea.setSelectionRange(textarea.selectionEnd - updated.length, textarea.selectionEnd);
      }
    }, 0);
  }
  textarea.focus();
}

function durationToString(millis) {
  let seconds = Math.floor(millis / 1000);
  let minutes = Math.floor(seconds / 60);
  let hours = Math.floor(seconds / 60 / 60);
  let days = Math.floor(seconds / 60 / 60 / 24);
  let months = Math.floor(seconds / 60 / 60 / 24 / 30);
  let years = Math.floor(seconds / 60 / 60 / 24 / 365 * 10) / 10;
  if (years > 1) {
    return years + 'y';
  } else if (months > 0) {
    return months + 'M';
  } else if (days > 0) {
    return days + 'd';
  } else if (hours > 0) {
    return hours + 'h';
  } else {
    return minutes + 'm';
  }
}
</script>
